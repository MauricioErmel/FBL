const hexagonDataWarm = {
    '1A': {
        redImage: 'img/weather/bloqueioEsquerdo.webp',
        blueImage: null,
        //text: '1A',
        blocked: true,
        visible: true,
        q: 1,
        r: -1
    },
    '0': {
        redImage: 'img/weather/bloqueioSuperior.webp',
        blueImage: null,
        //text: '0',
        blocked: true,
        visible: true,
        q: 2,
        r: -1
    },
    '3A': {
        redImage: 'img/weather/bloqueioDireito.webp',
        blueImage: null,
        //text: '3A',
        blocked: true,
        visible: true,
        q: 3,
        r: -1
    },
    '1B': {
        redImage: 'img/weather/bloqueioInferiorEsquerdo.webp',
        blueImage: null,
        //text: '1B',
        blocked: true,
        visible: true,
        q: -1,
        r: 2
    },
    '2B': {
        redImage: 'img/weather/bloqueioInferiorDireito.webp',
        blueImage: null,
        //text: '2B',
        blocked: true,
        visible: true,
        q: 5,
        r: 1
    },
    '19A': {
        redImage: 'img/weather/bloqueioInferior.webp',
        blueImage: null,
        //text: '19A',
        blocked: true,
        visible: true,
        q: 2,
        r: 5
    },
    1: {
        redImage: 'img/weather/diaQuenteDeSol.webp',
        blueImage: null,
        text: '',
        temperatureModHot: null
    },
    2: {
        redImage: 'img/weather/diaQuenteDeSol.webp',
        blueImage: null,
        text: '',
        temperatureModHot: null
    },
    3: {
        redImage: 'img/weather/temporal.webp',
        blueImage: 'img/weather/vento3.webp',
        text: '',
        temperatureModHot: -4
    },
    4: {
        redImage: 'img/weather/ceuLimpo.webp',
        blueImage: 'img/weather/vento0.webp',
        text: '',
        temperatureModHot: +1
    },
    5: {
        redImage: 'img/weather/ceuLimpo.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModHot: -1
    },
    6: {
        redImage: 'img/weather/garoa.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModHot: -2
    },
    7: {
        redImage: 'img/weather/nuvensPesadas.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModHot: -1
    },
    8: {
        redImage: 'img/weather/chuvaForte.webp',
        blueImage: 'img/weather/vento3.webp',
        text: '',
        temperatureModHot: -4
    },
    9: {
        redImage: 'img/weather/ceuLimpo.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModHot: null
    },
    10: {
        redImage: 'img/weather/nuvensClaras.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModHot: -1
    },
    11: {
        redImage: 'img/weather/garoa.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModHot: -1
    },
    12: {
        redImage: 'img/weather/chuvaLeve.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModHot: -2
    },
    13: {
        redImage: 'img/weather/chuvaForte.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModHot: -3
    },
    14: {
        redImage: 'img/weather/garoa.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModHot: -2
    },
    15: {
        redImage: 'img/weather/nuvensClaras.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModHot: null
    },
    16: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModHot: null
    },
    17: {
        redImage: 'img/weather/encoberto.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModHot: null
    },
    18: {
        redImage: 'img/weather/chuvaLeve.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModHot: -2
    },
    19: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento0.webp',
        text: '',
        temperatureModHot: +1
    }
};

const hexagonDataIntermediate = {
    '1A': {
        redImage: 'img/weather/bloqueioEsquerdo.webp',
        blueImage: null,
        //text: '1A',
        blocked: true,
        visible: true,
        q: 1,
        r: -1
    },
    '0': {
        redImage: 'img/weather/bloqueioSuperior.webp',
        blueImage: null,
        //text: '0',
        blocked: true,
        visible: true,
        q: 2,
        r: -1
    },
    '3A': {
        redImage: 'img/weather/bloqueioDireito.webp',
        blueImage: null,
        //text: '3A',
        blocked: true,
        visible: true,
        q: 3,
        r: -1
    },
    '1B': {
        redImage: 'img/weather/bloqueioInferiorEsquerdo.webp',
        blueImage: null,
        //text: '1B',
        blocked: true,
        visible: true,
        q: -1,
        r: 2
    },
    '2B': {
        redImage: 'img/weather/bloqueioInferiorDireito.webp',
        blueImage: null,
        //text: '2B',
        blocked: true,
        visible: true,
        q: 5,
        r: 1
    },
    '19A': {
        redImage: 'img/weather/bloqueioInferior.webp',
        blueImage: null,
        //text: '19A',
        blocked: true,
        visible: true,
        q: 2,
        r: 5
    },
    1: {
        redImage: 'img/weather/diaDeFrioCortante.webp',
        blueImage: null,
        text: '',
        temperatureModCold: null
    },
    2: {
        redImage: 'img/weather/diaDeFrioCortante.webp',
        blueImage: null,
        text: '',
        temperatureModCold: null
    },
    3: {
        redImage: 'img/weather/neve.webp',
        blueImage: 'img/weather/vento3.webp',
        text: '',
        temperatureModCold: +4
    },
    4: {
        redImage: 'img/weather/ceuLimpo.webp',
        blueImage: 'img/weather/vento0.webp',
        text: '',
        temperatureModCold: null
    },
    5: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    6: {
        redImage: 'img/weather/nuvensPesadas.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    7: {
        redImage: 'img/weather/rajadaDeNeve.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    8: {
        redImage: 'img/weather/rajadaDeNeve.webp',
        blueImage: 'img/weather/vento3.webp',
        text: '',
        temperatureModCold: +2
    },
    9: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: null
    },
    10: {
        redImage: 'img/weather/encoberto.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    11: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: null
    },
    12: {
        redImage: 'img/weather/chuvaLeve.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +2
    },
    13: {
        redImage: 'img/weather/chuvaForte.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +3
    },
    14: {
        redImage: 'img/weather/garoa.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +2
    },
    15: {
        redImage: 'img/weather/garoa.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: +1
    },
    16: {
        redImage: 'img/weather/nuvensClaras.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: null
    },
    17: {
        redImage: 'img/weather/encoberto.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: null
    },
    18: {
        redImage: 'img/weather/chuvaLeve.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +2
    },
    19: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento0.webp',
        text: '',
        temperatureModCold: null
    }
};

const hexagonDataWinter = {
    '1A': {
        redImage: 'img/weather/bloqueioEsquerdo.webp',
        blueImage: null,
        //text: '1A',
        blocked: true,
        visible: true,
        q: 1,
        r: -1
    },
    '0': {
        redImage: 'img/weather/bloqueioSuperior.webp',
        blueImage: null,
        //text: '0',
        blocked: true,
        visible: true,
        q: 2,
        r: -1
    },
    '3A': {
        redImage: 'img/weather/bloqueioDireito.webp',
        blueImage: null,
        //text: '3A',
        blocked: true,
        visible: true,
        q: 3,
        r: -1
    },
    '1B': {
        redImage: 'img/weather/bloqueioInferiorEsquerdo.webp',
        blueImage: null,
        //text: '1B',
        blocked: true,
        visible: true,
        q: -1,
        r: 2
    },
    '2B': {
        redImage: 'img/weather/bloqueioInferiorDireito.webp',
        blueImage: null,
        //text: '2B',
        blocked: true,
        visible: true,
        q: 5,
        r: 1
    },
    '19A': {
        redImage: 'img/weather/bloqueioInferior.webp',
        blueImage: null,
        //text: '19A',
        blocked: true,
        visible: true,
        q: 2,
        r: 5
    },
    1: {
        redImage: 'img/weather/diaDeFrioCortante.webp',
        blueImage: null,
        text: '',
        temperatureModCold: null
    },
    2: {
        redImage: 'img/weather/diaDeFrioCortante.webp',
        blueImage: null,
        text: '',
        temperatureModCold: null
    },
    3: {
        redImage: 'img/weather/nevasca.webp',
        blueImage: 'img/weather/vento3.webp',
        text: '',
        temperatureModCold: +4
    },
    4: {
        redImage: 'img/weather/ceuLimpo.webp',
        blueImage: 'img/weather/vento0.webp',
        text: '',
        temperatureModCold: null
    },
    5: {
        redImage: 'img/weather/ceuLimpo.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    6: {
        redImage: 'img/weather/nuvensPesadas.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    7: {
        redImage: 'img/weather/encoberto.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    8: {
        redImage: 'img/weather/neve.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +3
    },
    9: {
        redImage: 'img/weather/ceuLimpo.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: null
    },
    10: {
        redImage: 'img/weather/nuvensClaras.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    11: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: null
    },
    12: {
        redImage: 'img/weather/rajadaDeNeve.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: +1
    },
    13: {
        redImage: 'img/weather/rajadaDeNeve.webp',
        blueImage: 'img/weather/vento3.webp',
        text: '',
        temperatureModCold: +3
    },
    14: {
        redImage: 'img/weather/rajadaDeNeve.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +2
    },
    15: {
        redImage: 'img/weather/nuvensClaras.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: null
    },
    16: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: null
    },
    17: {
        redImage: 'img/weather/encoberto.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    18: {
        redImage: 'img/weather/rajadaDeNeve.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +2
    },
    19: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento0.webp',
        text: '',
        temperatureModCold: null
    }
};

const weatherEffects = {
    'Dia Quente de Sol': '✥ +1 em rolagens de DESBRAVAR',
    'Dia de Frio Cortante': '✥ -1 em rolagens de DESBRAVAR',
    'Céu Limpo': '✥ +1 em rolagens de DESBRAVAR',
    'Garoa': '✥ +1 para rolar na tabela de FRIO<br>✥ -1 para rolar na tabela de CALOR<br>✥ -1 em rolagens de DESBRAVAR',
    'Chuva Leve': '✥ +1 para rolar na tabela de FRIO<br>✥ -1 para rolar na tabela de CALOR<br>✥ -1 em rolagens de DESBRAVAR',
    'Chuva Forte': '✥ +2 para rolar na tabela de FRIO<br>✥ -2 para rolar na tabela de CALOR<br>✥ -2 em rolagens de DESBRAVAR<br>✥ CAMINHAR requer uma rolagem de Resiliência',
    'Temporal': '✥ +2 para rolar na tabela de FRIO<br>✥ -2 para rolar na tabela de CALOR<br>✥ -2 em rolagens de DESBRAVAR<br>✥ CAMINHAR requer uma rolagem de Resiliência',
    'Rajada de Neve': '✥ +1 para rolar na tabela de FRIO<br>✥ -1 em rolagens de DESBRAVAR<br>',
    'Neve': '✥ +2 para rolar na tabela de FRIO<br>✥ -2 em rolagens de DESBRAVAR<br>✥ CAMINHAR requer uma rolagem de Resiliência',
    'Nevasca': '✥ +2 para rolar na tabela de FRIO<br>✥ -2 em rolagens de DESBRAVAR<br>✥ CAMINHAR requer uma rolagem de Resiliência',
    'Sem Vento': '✥ +1 em rolagens de MONTAR ACAMPAMENTO<br>✥ +1 para rolar na tabela de CALOR',
    'Ventando': '✥ +1 para rolar na tabela de FRIO<br>✥ -1 para rolar na tabela de CALOR<br>✥ -1 em rolagens de MONTAR ACAMPAMENTO',
    'Ventania Forte': '✥ +2 para rolar na tabela de FRIO<br>✥ -2 para rolar na tabela de CALOR<br>✥ -2 em rolagens de MONTAR ACAMPAMENTO<br>✥ CAMINHAR requer uma rolagem de Resiliência.'
};

function getImageTitle(imagePath) {
    if (!imagePath) return '';
    const imageName = imagePath.split('/').pop();
    if (imageName === 'ceuLimpo.webp') return 'Céu Limpo';
    if (imageName === 'chuvaForte.webp') return 'Chuva Forte';
    if (imageName === 'chuvaLeve.webp') return 'Chuva Leve';
    if (imageName === 'diaQuenteDeSol.webp') return 'Dia Quente de Sol';
    if (imageName === 'diaDeFrioCortante.webp') return 'Dia de Frio Cortante';
    if (imageName === 'encoberto.webp') return 'Encoberto';
    if (imageName === 'garoa.webp') return 'Garoa';
    if (imageName === 'nebuloso.webp') return 'Nebuloso';
    if (imageName === 'nevasca.webp') return 'Nevasca';
    if (imageName === 'neve.webp') return 'Neve';
    if (imageName === 'nuvensClaras.webp') return 'Nuvens Claras';
    if (imageName === 'nuvensPesadas.webp') return 'Nuvens Pesadas';
    if (imageName === 'rajadaDeNeve.webp') return 'Rajada de Neve';
    if (imageName === 'temporal.webp') return 'Temporal';
    if (imageName === 'vento0.webp') return 'Sem Vento';
    if (imageName === 'vento1.webp') return 'Brisa';
    if (imageName === 'vento2.webp') return 'Ventando';
    if (imageName === 'vento3.webp') return 'Ventania Forte';
    return '';
}

function parseEffect(effectString) {
    const effectRegex = /✥\s*([+-]\d+)?\s*(.*)/;
    const match = effectString.match(effectRegex);
    if (match) {
        const value = match[1] ? parseInt(match[1]) : null;
        let description = match[2].trim();
        if (description.endsWith('.')) {
            description = description.slice(0, -1);
        }
        return { value, description };
    }
    return null;
}

function processDataSets(data, excludedPhrases = []) {
    for (const key in data) {
        const hexagon = data[key];
        const redTitle = getImageTitle(hexagon.redImage);
        const blueTitle = getImageTitle(hexagon.blueImage);

        let title = '';
        if (redTitle && blueTitle) {
            title = `${redTitle} e ${blueTitle}`;
        } else if (redTitle) {
            title = redTitle;
        } else if (blueTitle) {
            title = blueTitle;
        }

        const redEffectStrings = (redTitle && weatherEffects[redTitle]) ? weatherEffects[redTitle].split('<br>') : [];
        const blueEffectStrings = (blueTitle && weatherEffects[blueTitle]) ? weatherEffects[blueTitle].split('<br>') : [];

        // Track effects and their sources
        const effectsMap = new Map(); // Key: description, Value: { value: num, sources: [] }

        const addEffects = (strings, sourceImage) => {
            for (const effectString of strings) {
                const parsed = parseEffect(effectString);
                if (parsed) {
                    const { value, description } = parsed;

                    // Check exclusions
                    if (excludedPhrases.some(phrase => description.includes(phrase))) {
                        continue;
                    }

                    if (effectsMap.has(description)) {
                        const existing = effectsMap.get(description);
                        // Accumulate value if both are numeric
                        if (existing.value !== null && value !== null) {
                            existing.value += value;
                        }
                        if (sourceImage && !existing.sources.includes(sourceImage)) {
                            existing.sources.push(sourceImage);
                        }
                    } else {
                        // First time seeing this description
                        effectsMap.set(description, { value, sources: sourceImage ? [sourceImage] : [] });
                    }
                }
            }
        };

        addEffects(redEffectStrings, hexagon.redImage);
        addEffects(blueEffectStrings, hexagon.blueImage);

        const redImageName = hexagon.redImage ? hexagon.redImage.split('/').pop() : null;
        const blueImageName = hexagon.blueImage ? hexagon.blueImage.split('/').pop() : null;

        const conditionRed = ['chuvaForte.webp', 'temporal.webp', 'neve.webp', 'nevasca.webp'].includes(redImageName);
        const conditionBlue = blueImageName === 'vento3.webp';

        if (conditionRed && conditionBlue) {
            if (effectsMap.has('CAMINHAR requer uma rolagem de Resiliência')) {
                const oldEntry = effectsMap.get('CAMINHAR requer uma rolagem de Resiliência');
                effectsMap.delete('CAMINHAR requer uma rolagem de Resiliência');

                // Add new entry with combined sources
                effectsMap.set('CAMINHAR requer uma rolagem de Resiliência com um redutor de -2', {
                    value: null,
                    sources: oldEntry.sources
                });
            }
        }

        let effectsString = '';
        for (const [description, { value, sources }] of effectsMap.entries()) {
            if (effectsString) effectsString += '<br>';

            // Build tags
            let tagsHtml = '';
            sources.forEach(src => {
                tagsHtml += `<img src="${src}" class="source-tag" onclick="showGeneralPopup('${src}')">`;
            });
            // Fallback for no source? Should not happen given logic, but maybe for manual adds.
            if (!tagsHtml) tagsHtml = `<span style="font-size:1.2em; vertical-align:middle; margin-right:5px;">✥</span>`;

            if (value !== null && value !== 0) {
                const sign = value > 0 ? '+' : '';
                effectsString += `${tagsHtml} ${sign}${value} ${description}`;
            } else if (value === null) {
                effectsString += `${tagsHtml} ${description}`;
            }
        }

        if (title) {
            hexagon.text = `<b>${title}</b>`;
            if (effectsString) {
                hexagon.text += `<br>${effectsString}`;
            }
        }
    }
}

// Process all sets
processDataSets(hexagonDataWarm, ['para rolar na tabela de FRIO']);
processDataSets(hexagonDataIntermediate, ['para rolar na tabela de CALOR']);
processDataSets(hexagonDataWinter, ['para rolar na tabela de CALOR']);

// Initialize with a default, but script.js will update it
let hexagonData = hexagonDataWarm;

function updateActiveHexagonData(monthName) {
    if (['Minguaprimavera', 'Cresceverão', 'Minguaverão', 'Cresceoutono'].includes(monthName)) {
        hexagonData = hexagonDataWarm;
    } else if (['Cresceprimavera', 'Minguaoutono'].includes(monthName)) {
        hexagonData = hexagonDataIntermediate;
    } else if (['Cresceinverno', 'Minguainverno'].includes(monthName)) {
        hexagonData = hexagonDataWinter;
    }
}