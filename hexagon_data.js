const hexagonDataWarm = {
    '1A': {
        redImage: 'img/weather/bloqueioEsquerdo.png',
        blueImage: null,
        //text: '1A',
        blocked: true,
        visible: true,
        q: 1,
        r: -1
    },
    '0': {
        redImage: 'img/weather/bloqueioSuperior.png',
        blueImage: null,
        //text: '0',
        blocked: true,
        visible: true,
        q: 2,
        r: -1
    },
    '3A': {
        redImage: 'img/weather/bloqueioDireito.png',
        blueImage: null,
        //text: '3A',
        blocked: true,
        visible: true,
        q: 3,
        r: -1
    },
    '1B': {
        redImage: 'img/weather/bloqueioInferiorEsquerdo.png',
        blueImage: null,
        //text: '1B',
        blocked: true,
        visible: true,
        q: -1,
        r: 2
    },
    '2B': {
        redImage: 'img/weather/bloqueioInferiorDireito.png',
        blueImage: null,
        //text: '2B',
        blocked: true,
        visible: true,
        q: 5,
        r: 1
    },
    '19A': {
        redImage: 'img/weather/bloqueioInferior.png',
        blueImage: null,
        //text: '19A',
        blocked: true,
        visible: true,
        q: 2,
        r: 5
    },
    1: {
        redImage: 'img/weather/diaQuenteDeSol.png',
        blueImage: null,
        text: '',
        temperatureModHot: null
    },
    2: {
        redImage: 'img/weather/diaQuenteDeSol.png',
        blueImage: null,
        text: '',
        temperatureModHot: null
    },
    3: {
        redImage: 'img/weather/temporal.png',
        blueImage: 'img/weather/vento3.png',
        text: '',
        temperatureModHot: -4
    },
    4: {
        redImage: 'img/weather/ceuLimpo.png',
        blueImage: 'img/weather/vento0.png',
        text: '',
        temperatureModHot: +1
    },
    5: {
        redImage: 'img/weather/ceuLimpo.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModHot: -1
    },
    6: {
        redImage: 'img/weather/garoa.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModHot: -2
    },
    7: {
        redImage: 'img/weather/nuvensPesadas.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModHot: -1
    },
    8: {
        redImage: 'img/weather/chuvaForte.png',
        blueImage: 'img/weather/vento3.png',
        text: '',
        temperatureModHot: -4
    },
    9: {
        redImage: 'img/weather/ceuLimpo.png',
        blueImage: 'img/weather/vento1.png',
        text: '',
        temperatureModHot: null
    },
    10: {
        redImage: 'img/weather/nuvensClaras.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModHot: -1
    },
    11: {
        redImage: 'img/weather/garoa.png',
        blueImage: 'img/weather/vento1.png',
        text: '',
        temperatureModHot: -1
    },
    12: {
        redImage: 'img/weather/chuvaLeve.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModHot: -2
    },
    13: {
        redImage: 'img/weather/chuvaForte.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModHot: -3
    },
    14: {
        redImage: 'img/weather/garoa.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModHot: -2
    },
    15: {
        redImage: 'img/weather/nuvensClaras.png',
        blueImage: 'img/weather/vento1.png',
        text: '',
        temperatureModHot: null
    },
    16: {
        redImage: 'img/weather/nebuloso.png',
        blueImage: 'img/weather/vento1.png',
        text: '',
        temperatureModHot: null
    },
    17: {
        redImage: 'img/weather/encoberto.png',
        blueImage: 'img/weather/vento1.png',
        text: '',
        temperatureModHot: null
    },
    18: {
        redImage: 'img/weather/chuvaLeve.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModHot: -2
    },
    19: {
        redImage: 'img/weather/nebuloso.png',
        blueImage: 'img/weather/vento0.png',
        text: '',
        temperatureModHot: +1
    }
};

const hexagonDataIntermediate = {
    '1A': {
        redImage: 'img/weather/bloqueioEsquerdo.png',
        blueImage: null,
        //text: '1A',
        blocked: true,
        visible: true,
        q: 1,
        r: -1
    },
    '0': {
        redImage: 'img/weather/bloqueioSuperior.png',
        blueImage: null,
        //text: '0',
        blocked: true,
        visible: true,
        q: 2,
        r: -1
    },
    '3A': {
        redImage: 'img/weather/bloqueioDireito.png',
        blueImage: null,
        //text: '3A',
        blocked: true,
        visible: true,
        q: 3,
        r: -1
    },
    '1B': {
        redImage: 'img/weather/bloqueioInferiorEsquerdo.png',
        blueImage: null,
        //text: '1B',
        blocked: true,
        visible: true,
        q: -1,
        r: 2
    },
    '2B': {
        redImage: 'img/weather/bloqueioInferiorDireito.png',
        blueImage: null,
        //text: '2B',
        blocked: true,
        visible: true,
        q: 5,
        r: 1
    },
    '19A': {
        redImage: 'img/weather/bloqueioInferior.png',
        blueImage: null,
        //text: '19A',
        blocked: true,
        visible: true,
        q: 2,
        r: 5
    },
    1: {
        redImage: 'img/weather/diaDeFrioCortante.png',
        blueImage: null,
        text: '',
        temperatureModCold: null
    },
    2: {
        redImage: 'img/weather/diaDeFrioCortante.png',
        blueImage: null,
        text: '',
        temperatureModCold: null
    },
    3: {
        redImage: 'img/weather/neve.png',
        blueImage: 'img/weather/vento3.png',
        text: '',
        temperatureModCold: +4
    },
    4: {
        redImage: 'img/weather/ceuLimpo.png',
        blueImage: 'img/weather/vento0.png',
        text: '',
        temperatureModCold: null
    },
    5: {
        redImage: 'img/weather/nebuloso.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModCold: +1
    },
    6: {
        redImage: 'img/weather/nuvensPesadas.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModCold: +1
    },
    7: {
        redImage: 'img/weather/rajadaDeNeve.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModCold: +1
    },
    8: {
        redImage: 'img/weather/rajadaDeNeve.png',
        blueImage: 'img/weather/vento3.png',
        text: '',
        temperatureModCold: +2
    },
    9: {
        redImage: 'img/weather/nebuloso.png',
        blueImage: 'img/weather/vento1.png',
        text: '',
        temperatureModCold: null
    },
    10: {
        redImage: 'img/weather/encoberto.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModCold: +1
    },
    11: {
        redImage: 'img/weather/nebuloso.png',
        blueImage: 'img/weather/vento1.png',
        text: '',
        temperatureModCold: null
    },
    12: {
        redImage: 'img/weather/chuvaLeve.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModCold: +2
    },
    13: {
        redImage: 'img/weather/chuvaForte.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModCold: +3
    },
    14: {
        redImage: 'img/weather/garoa.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModCold: +2
    },
    15: {
        redImage: 'img/weather/garoa.png',
        blueImage: 'img/weather/vento1.png',
        text: '',
        temperatureModCold: +1
    },
    16: {
        redImage: 'img/weather/nuvensClaras.png',
        blueImage: 'img/weather/vento1.png',
        text: '',
        temperatureModCold: null
    },
    17: {
        redImage: 'img/weather/encoberto.png',
        blueImage: 'img/weather/vento1.png',
        text: '',
        temperatureModCold: null
    },
    18: {
        redImage: 'img/weather/chuvaLeve.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModCold: +2
    },
    19: {
        redImage: 'img/weather/nebuloso.png',
        blueImage: 'img/weather/vento0.png',
        text: '',
        temperatureModCold: null
    }
};

const hexagonDataWinter = {
    '1A': {
        redImage: 'img/weather/bloqueioEsquerdo.png',
        blueImage: null,
        //text: '1A',
        blocked: true,
        visible: true,
        q: 1,
        r: -1
    },
    '0': {
        redImage: 'img/weather/bloqueioSuperior.png',
        blueImage: null,
        //text: '0',
        blocked: true,
        visible: true,
        q: 2,
        r: -1
    },
    '3A': {
        redImage: 'img/weather/bloqueioDireito.png',
        blueImage: null,
        //text: '3A',
        blocked: true,
        visible: true,
        q: 3,
        r: -1
    },
    '1B': {
        redImage: 'img/weather/bloqueioInferiorEsquerdo.png',
        blueImage: null,
        //text: '1B',
        blocked: true,
        visible: true,
        q: -1,
        r: 2
    },
    '2B': {
        redImage: 'img/weather/bloqueioInferiorDireito.png',
        blueImage: null,
        //text: '2B',
        blocked: true,
        visible: true,
        q: 5,
        r: 1
    },
    '19A': {
        redImage: 'img/weather/bloqueioInferior.png',
        blueImage: null,
        //text: '19A',
        blocked: true,
        visible: true,
        q: 2,
        r: 5
    },
    1: {
        redImage: 'img/weather/diaDeFrioCortante.png',
        blueImage: null,
        text: '',
        temperatureModCold: null
    },
    2: {
        redImage: 'img/weather/diaDeFrioCortante.png',
        blueImage: null,
        text: '',
        temperatureModCold: null
    },
    3: {
        redImage: 'img/weather/nevasca.png',
        blueImage: 'img/weather/vento3.png',
        text: '',
        temperatureModCold: +4
    },
    4: {
        redImage: 'img/weather/ceuLimpo.png',
        blueImage: 'img/weather/vento0.png',
        text: '',
        temperatureModCold: null
    },
    5: {
        redImage: 'img/weather/ceuLimpo.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModCold: +1
    },
    6: {
        redImage: 'img/weather/nuvensPesadas.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModCold: +1
    },
    7: {
        redImage: 'img/weather/encoberto.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModCold: +1
    },
    8: {
        redImage: 'img/weather/neve.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModCold: +3
    },
    9: {
        redImage: 'img/weather/ceuLimpo.png',
        blueImage: 'img/weather/vento1.png',
        text: '',
        temperatureModCold: null
    },
    10: {
        redImage: 'img/weather/nuvensClaras.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModCold: +1
    },
    11: {
        redImage: 'img/weather/nebuloso.png',
        blueImage: 'img/weather/vento1.png',
        text: '',
        temperatureModCold: null
    },
    12: {
        redImage: 'img/weather/rajadaDeNeve.png',
        blueImage: 'img/weather/vento1.png',
        text: '',
        temperatureModCold: +1
    },
    13: {
        redImage: 'img/weather/rajadaDeNeve.png',
        blueImage: 'img/weather/vento3.png',
        text: '',
        temperatureModCold: +3
    },
    14: {
        redImage: 'img/weather/rajadaDeNeve.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModCold: +2
    },
    15: {
        redImage: 'img/weather/nuvensClaras.png',
        blueImage: 'img/weather/vento1.png',
        text: '',
        temperatureModCold: null
    },
    16: {
        redImage: 'img/weather/nebuloso.png',
        blueImage: 'img/weather/vento1.png',
        text: '',
        temperatureModCold: null
    },
    17: {
        redImage: 'img/weather/encoberto.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModCold: +1
    },
    18: {
        redImage: 'img/weather/rajadaDeNeve.png',
        blueImage: 'img/weather/vento2.png',
        text: '',
        temperatureModCold: +2
    },
    19: {
        redImage: 'img/weather/nebuloso.png',
        blueImage: 'img/weather/vento0.png',
        text: '',
        temperatureModCold: null
    }
};

const weatherEffects = {
    'Dia Quente de Sol': '✥ +1 em rolagens de DESBRAVAR',
    'Dia de Frio Cortante': '✥ -1 em rolagens de DESBRAVAR',
    'Céu Limpo': '✥ +1 em rolagens de DESBRAVAR',
    'Garoa': '✥ +1 para rolar na tabela de FRIO<br>✥ -1 para rolar na tabela de CALOR<br>✥ -1 em rolagens de DESBRAVAR',
    'Chuva Leve': '✥ +1 para rolar na tabela de FRIO<br>✥ -1 para rolar na tabela de CALOR<br>✥ -1 em rolagens de DESBRAVAR',
    'Chuva Forte': '✥ +2 para rolar na tabela de FRIO<br>✥ -2 para rolar na tabela de CALOR<br>✥ -2 em rolagens de DESBRAVAR<br>✥ CAMINHAR requer uma rolagem de Resiliência',
    'Temporal': '✥ +2 para rolar na tabela de FRIO<br>✥ -2 para rolar na tabela de CALOR<br>✥ -2 em rolagens de DESBRAVAR<br>✥ CAMINHAR requer uma rolagem de Resiliência',
    'Rajada de Neve': '✥ +1 para rolar na tabela de FRIO<br>✥ -1 em rolagens de DESBRAVAR<br>',
    'Neve': '✥ +2 para rolar na tabela de FRIO<br>✥ -2 em rolagens de DESBRAVAR<br>✥ CAMINHAR requer uma rolagem de Resiliência',
    'Nevasca': '✥ +2 para rolar na tabela de FRIO<br>✥ -2 em rolagens de DESBRAVAR<br>✥ CAMINHAR requer uma rolagem de Resiliência',
    'Sem Vento': '✥ +1 em rolagens de MONTAR ACAMPAMENTO<br>✥ +1 para rolar na tabela de CALOR',
    'Ventando': '✥ +1 para rolar na tabela de FRIO<br>✥ -1 para rolar na tabela de CALOR<br>✥ -1 em rolagens de MONTAR ACAMPAMENTO',
    'Ventania Forte': '✥ +2 para rolar na tabela de FRIO<br>✥ -2 para rolar na tabela de CALOR<br>✥ -2 em rolagens de MONTAR ACAMPAMENTO<br>✥ CAMINHAR requer uma rolagem de Resiliência.'
};

function getImageTitle(imagePath) {
    if (!imagePath) return '';
    const imageName = imagePath.split('/').pop();
    if (imageName === 'ceuLimpo.png') return 'Céu Limpo';
    if (imageName === 'chuvaForte.png') return 'Chuva Forte';
    if (imageName === 'chuvaLeve.png') return 'Chuva Leve';
    if (imageName === 'diaQuenteDeSol.png') return 'Dia Quente de Sol';
    if (imageName === 'diaDeFrioCortante.png') return 'Dia de Frio Cortante';
    if (imageName === 'encoberto.png') return 'Encoberto';
    if (imageName === 'garoa.png') return 'Garoa';
    if (imageName === 'nebuloso.png') return 'Nebuloso';
    if (imageName === 'nevasca.png') return 'Nevasca';
    if (imageName === 'neve.png') return 'Neve';
    if (imageName === 'nuvensClaras.png') return 'Nuvens Claras';
    if (imageName === 'nuvensPesadas.png') return 'Nuvens Pesadas';
    if (imageName === 'rajadaDeNeve.png') return 'Rajada de Neve';
    if (imageName === 'temporal.png') return 'Temporal';
    if (imageName === 'vento0.png') return 'Sem Vento';
    if (imageName === 'vento1.png') return 'Brisa';
    if (imageName === 'vento2.png') return 'Ventando';
    if (imageName === 'vento3.png') return 'Ventania Forte';
    return '';
}

function parseEffect(effectString) {
    const effectRegex = /✥\s*([+-]\d+)?\s*(.*)/;
    const match = effectString.match(effectRegex);
    if (match) {
        const value = match[1] ? parseInt(match[1]) : null;
        let description = match[2].trim();
        if (description.endsWith('.')) {
            description = description.slice(0, -1);
        }
        return { value, description };
    }
    return null;
}

function processDataSets(data, excludedPhrases = []) {
    for (const key in data) {
        const hexagon = data[key];
        const redTitle = getImageTitle(hexagon.redImage);
        const blueTitle = getImageTitle(hexagon.blueImage);

        let title = '';
        if (redTitle && blueTitle) {
            title = `${redTitle} e ${blueTitle}`;
        } else if (redTitle) {
            title = redTitle;
        } else if (blueTitle) {
            title = blueTitle;
        }

        const redEffectStrings = (redTitle && weatherEffects[redTitle]) ? weatherEffects[redTitle].split('<br>') : [];
        const blueEffectStrings = (blueTitle && weatherEffects[blueTitle]) ? weatherEffects[blueTitle].split('<br>') : [];
        const allEffectStrings = [...redEffectStrings, ...blueEffectStrings];

        const effectsMap = new Map();

        for (const effectString of allEffectStrings) {
            const parsed = parseEffect(effectString);
            if (parsed) {
                const { value, description } = parsed;

                // Check exclusions
                if (excludedPhrases.some(phrase => description.includes(phrase))) {
                    continue;
                }

                if (effectsMap.has(description)) {
                    const existing = effectsMap.get(description);
                    if (existing.value !== null && value !== null) {
                        existing.value += value;
                    }
                } else {
                    effectsMap.set(description, { value });
                }
            }
        }

        const redImageName = hexagon.redImage ? hexagon.redImage.split('/').pop() : null;
        const blueImageName = hexagon.blueImage ? hexagon.blueImage.split('/').pop() : null;

        const conditionRed = ['chuvaForte.png', 'temporal.png', 'neve.png', 'nevasca.png'].includes(redImageName);
        const conditionBlue = blueImageName === 'vento3.png';

        if (conditionRed && conditionBlue) {
            if (effectsMap.has('CAMINHAR requer uma rolagem de Resiliência')) {
                effectsMap.delete('CAMINHAR requer uma rolagem de Resiliência');
                effectsMap.set('CAMINHAR requer uma rolagem de Resiliência com um redutor de -2', { value: null });
            }
        }

        let effectsString = '';
        for (const [description, { value }] of effectsMap.entries()) {
            if (effectsString) effectsString += '<br>';

            if (value !== null && value !== 0) {
                const sign = value > 0 ? '+' : '';
                effectsString += `✥ ${sign}${value} ${description}`;
            } else if (value === null) {
                effectsString += `✥ ${description}`;
            }
        }

        if (title) {
            hexagon.text = `<b>${title}</b>`;
            if (effectsString) {
                hexagon.text += `<br>${effectsString}`;
            }
        }
    }
}

// Process all sets
processDataSets(hexagonDataWarm, ['para rolar na tabela de FRIO']);
processDataSets(hexagonDataIntermediate, ['para rolar na tabela de CALOR']);
processDataSets(hexagonDataWinter, ['para rolar na tabela de CALOR']);

// Initialize with a default, but script.js will update it
let hexagonData = hexagonDataWarm;

function updateActiveHexagonData(monthName) {
    if (['Minguaprimavera', 'Cresceverão', 'Minguaverão', 'Cresceoutono'].includes(monthName)) {
        hexagonData = hexagonDataWarm;
    } else if (['Cresceprimavera', 'Minguaoutono'].includes(monthName)) {
        hexagonData = hexagonDataIntermediate;
    } else if (['Cresceinverno', 'Minguainverno'].includes(monthName)) {
        hexagonData = hexagonDataWinter;
    }
}