const hexagonDataWarm = {
    '1A': {
        redImage: 'img/weather/bloqueioEsquerdo.webp',
        blueImage: null,
        //text: '1A',
        blocked: true,
        visible: true,
        q: 1,
        r: -1
    },
    '0': {
        redImage: 'img/weather/bloqueioSuperior.webp',
        blueImage: null,
        //text: '0',
        blocked: true,
        visible: true,
        q: 2,
        r: -1
    },
    '3A': {
        redImage: 'img/weather/bloqueioDireito.webp',
        blueImage: null,
        //text: '3A',
        blocked: true,
        visible: true,
        q: 3,
        r: -1
    },
    '1B': {
        redImage: 'img/weather/bloqueioInferiorEsquerdo.webp',
        blueImage: null,
        //text: '1B',
        blocked: true,
        visible: true,
        q: -1,
        r: 2
    },
    '2B': {
        redImage: 'img/weather/bloqueioInferiorDireito.webp',
        blueImage: null,
        //text: '2B',
        blocked: true,
        visible: true,
        q: 5,
        r: 1
    },
    '19A': {
        redImage: 'img/weather/bloqueioInferior.webp',
        blueImage: null,
        //text: '19A',
        blocked: true,
        visible: true,
        q: 2,
        r: 5
    },
    1: {
        redImage: 'img/weather/diaQuenteDeSol.webp',
        blueImage: null,
        text: '',
        temperatureModHot: null
    },
    2: {
        redImage: 'img/weather/diaQuenteDeSol.webp',
        blueImage: null,
        text: '',
        temperatureModHot: null
    },
    3: {
        redImage: 'img/weather/temporal.webp',
        blueImage: 'img/weather/vento3.webp',
        text: '',
        temperatureModHot: -4
    },
    4: {
        redImage: 'img/weather/ceuLimpo.webp',
        blueImage: 'img/weather/vento0.webp',
        text: '',
        temperatureModHot: +1
    },
    5: {
        redImage: 'img/weather/ceuLimpo.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModHot: -1
    },
    6: {
        redImage: 'img/weather/garoa.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModHot: -2
    },
    7: {
        redImage: 'img/weather/nuvensPesadas.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModHot: -1
    },
    8: {
        redImage: 'img/weather/chuvaForte.webp',
        blueImage: 'img/weather/vento3.webp',
        text: '',
        temperatureModHot: -4
    },
    9: {
        redImage: 'img/weather/ceuLimpo.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModHot: null
    },
    10: {
        redImage: 'img/weather/nuvensClaras.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModHot: -1
    },
    11: {
        redImage: 'img/weather/garoa.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModHot: -1
    },
    12: {
        redImage: 'img/weather/chuvaLeve.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModHot: -2
    },
    13: {
        redImage: 'img/weather/chuvaForte.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModHot: -3
    },
    14: {
        redImage: 'img/weather/garoa.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModHot: -2
    },
    15: {
        redImage: 'img/weather/nuvensClaras.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModHot: null
    },
    16: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModHot: null
    },
    17: {
        redImage: 'img/weather/encoberto.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModHot: null
    },
    18: {
        redImage: 'img/weather/chuvaLeve.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModHot: -2
    },
    19: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento0.webp',
        text: '',
        temperatureModHot: +1
    }
};

const hexagonDataIntermediate = {
    '1A': {
        redImage: 'img/weather/bloqueioEsquerdo.webp',
        blueImage: null,
        //text: '1A',
        blocked: true,
        visible: true,
        q: 1,
        r: -1
    },
    '0': {
        redImage: 'img/weather/bloqueioSuperior.webp',
        blueImage: null,
        //text: '0',
        blocked: true,
        visible: true,
        q: 2,
        r: -1
    },
    '3A': {
        redImage: 'img/weather/bloqueioDireito.webp',
        blueImage: null,
        //text: '3A',
        blocked: true,
        visible: true,
        q: 3,
        r: -1
    },
    '1B': {
        redImage: 'img/weather/bloqueioInferiorEsquerdo.webp',
        blueImage: null,
        //text: '1B',
        blocked: true,
        visible: true,
        q: -1,
        r: 2
    },
    '2B': {
        redImage: 'img/weather/bloqueioInferiorDireito.webp',
        blueImage: null,
        //text: '2B',
        blocked: true,
        visible: true,
        q: 5,
        r: 1
    },
    '19A': {
        redImage: 'img/weather/bloqueioInferior.webp',
        blueImage: null,
        //text: '19A',
        blocked: true,
        visible: true,
        q: 2,
        r: 5
    },
    1: {
        redImage: 'img/weather/diaDeFrioCortante.webp',
        blueImage: null,
        text: '',
        temperatureModCold: null
    },
    2: {
        redImage: 'img/weather/diaDeFrioCortante.webp',
        blueImage: null,
        text: '',
        temperatureModCold: null
    },
    3: {
        redImage: 'img/weather/neve.webp',
        blueImage: 'img/weather/vento3.webp',
        text: '',
        temperatureModCold: +4
    },
    4: {
        redImage: 'img/weather/ceuLimpo.webp',
        blueImage: 'img/weather/vento0.webp',
        text: '',
        temperatureModCold: null
    },
    5: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    6: {
        redImage: 'img/weather/nuvensPesadas.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    7: {
        redImage: 'img/weather/rajadaDeNeve.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    8: {
        redImage: 'img/weather/rajadaDeNeve.webp',
        blueImage: 'img/weather/vento3.webp',
        text: '',
        temperatureModCold: +2
    },
    9: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: null
    },
    10: {
        redImage: 'img/weather/encoberto.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    11: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: null
    },
    12: {
        redImage: 'img/weather/chuvaLeve.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +2
    },
    13: {
        redImage: 'img/weather/chuvaForte.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +3
    },
    14: {
        redImage: 'img/weather/garoa.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +2
    },
    15: {
        redImage: 'img/weather/garoa.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: +1
    },
    16: {
        redImage: 'img/weather/nuvensClaras.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: null
    },
    17: {
        redImage: 'img/weather/encoberto.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: null
    },
    18: {
        redImage: 'img/weather/chuvaLeve.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +2
    },
    19: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento0.webp',
        text: '',
        temperatureModCold: null
    }
};

const hexagonDataWinter = {
    '1A': {
        redImage: 'img/weather/bloqueioEsquerdo.webp',
        blueImage: null,
        //text: '1A',
        blocked: true,
        visible: true,
        q: 1,
        r: -1
    },
    '0': {
        redImage: 'img/weather/bloqueioSuperior.webp',
        blueImage: null,
        //text: '0',
        blocked: true,
        visible: true,
        q: 2,
        r: -1
    },
    '3A': {
        redImage: 'img/weather/bloqueioDireito.webp',
        blueImage: null,
        //text: '3A',
        blocked: true,
        visible: true,
        q: 3,
        r: -1
    },
    '1B': {
        redImage: 'img/weather/bloqueioInferiorEsquerdo.webp',
        blueImage: null,
        //text: '1B',
        blocked: true,
        visible: true,
        q: -1,
        r: 2
    },
    '2B': {
        redImage: 'img/weather/bloqueioInferiorDireito.webp',
        blueImage: null,
        //text: '2B',
        blocked: true,
        visible: true,
        q: 5,
        r: 1
    },
    '19A': {
        redImage: 'img/weather/bloqueioInferior.webp',
        blueImage: null,
        //text: '19A',
        blocked: true,
        visible: true,
        q: 2,
        r: 5
    },
    1: {
        redImage: 'img/weather/diaDeFrioCortante.webp',
        blueImage: null,
        text: '',
        temperatureModCold: null
    },
    2: {
        redImage: 'img/weather/diaDeFrioCortante.webp',
        blueImage: null,
        text: '',
        temperatureModCold: null
    },
    3: {
        redImage: 'img/weather/nevasca.webp',
        blueImage: 'img/weather/vento3.webp',
        text: '',
        temperatureModCold: +4
    },
    4: {
        redImage: 'img/weather/ceuLimpo.webp',
        blueImage: 'img/weather/vento0.webp',
        text: '',
        temperatureModCold: null
    },
    5: {
        redImage: 'img/weather/ceuLimpo.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    6: {
        redImage: 'img/weather/nuvensPesadas.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    7: {
        redImage: 'img/weather/encoberto.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    8: {
        redImage: 'img/weather/neve.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +3
    },
    9: {
        redImage: 'img/weather/ceuLimpo.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: null
    },
    10: {
        redImage: 'img/weather/nuvensClaras.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    11: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: null
    },
    12: {
        redImage: 'img/weather/rajadaDeNeve.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: +1
    },
    13: {
        redImage: 'img/weather/rajadaDeNeve.webp',
        blueImage: 'img/weather/vento3.webp',
        text: '',
        temperatureModCold: +3
    },
    14: {
        redImage: 'img/weather/rajadaDeNeve.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +2
    },
    15: {
        redImage: 'img/weather/nuvensClaras.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: null
    },
    16: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento1.webp',
        text: '',
        temperatureModCold: null
    },
    17: {
        redImage: 'img/weather/encoberto.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +1
    },
    18: {
        redImage: 'img/weather/rajadaDeNeve.webp',
        blueImage: 'img/weather/vento2.webp',
        text: '',
        temperatureModCold: +2
    },
    19: {
        redImage: 'img/weather/nebuloso.webp',
        blueImage: 'img/weather/vento0.webp',
        text: '',
        temperatureModCold: null
    }
};

// Estrutura de modificadores para condições climáticas e de vento
const weatherModifiers = {
    // --- CONDIÇÕES CLIMÁTICAS (redImage) ---
    'Dia Quente de Sol': {
        desbravar: +1,
        acampar: 0,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: 0, cold: 0 },
        outros: []
    },
    'Dia de Frio Cortante': {
        desbravar: -1,
        acampar: 0,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: 0, cold: 0 },
        outros: []
    },
    'Céu Limpo': {
        desbravar: +1,
        acampar: 0,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: 0, cold: 0 },
        outros: []
    },
    'Garoa': {
        desbravar: -1,
        acampar: 0,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: -1, cold: +1 },
        outros: []
    },
    'Chuva Leve': {
        desbravar: -1,
        acampar: 0,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: -1, cold: +1 },
        outros: []
    },
    'Chuva Forte': {
        desbravar: -2,
        acampar: 0,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: -2, cold: +2 },
        outros: ['CAMINHAR requer uma rolagem de Resiliência.']
    },
    'Temporal': {
        desbravar: -2,
        acampar: 0,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: -2, cold: +2 },
        outros: ['CAMINHAR requer uma rolagem de Resiliência.']
    },
    'Rajada de Neve': {
        desbravar: -1,
        acampar: 0,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: 0, cold: +1 },
        outros: []
    },
    'Neve': {
        desbravar: -2,
        acampar: 0,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: 0, cold: +2 },
        outros: ['CAMINHAR requer uma rolagem de Resiliência.']
    },
    'Nevasca': {
        desbravar: -2,
        acampar: 0,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: 0, cold: +2 },
        outros: ['CAMINHAR requer uma rolagem de Resiliência.']
    },
    'Nebuloso': {
        desbravar: 0,
        acampar: 0,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: 0, cold: 0 },
        outros: []
    },
    'Encoberto': {
        desbravar: 0,
        acampar: 0,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: 0, cold: 0 },
        outros: []
    },
    'Nuvens Claras': {
        desbravar: 0,
        acampar: 0,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: 0, cold: 0 },
        outros: []
    },
    'Nuvens Pesadas': {
        desbravar: 0,
        acampar: 0,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: 0, cold: 0 },
        outros: []
    },

    // --- CONDIÇÕES DE VENTO (blueImage) ---
    'Sem Vento': {
        desbravar: 0,
        acampar: +1,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: +1, cold: 0 },
        outros: []
    },
    'Brisa': {
        desbravar: 0,
        acampar: 0,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: 0, cold: 0 },
        outros: []
    },
    'Ventando': {
        desbravar: 0,
        acampar: -1,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: -1, cold: +1 },
        outros: []
    },
    'Ventania Forte': {
        desbravar: 0,
        acampar: -2,
        coletar: 0,
        cacar: 0,
        temperaturaMod: { hot: -2, cold: +2 },
        outros: ['CAMINHAR requer uma rolagem de Resiliência.']
    }
};

// Dynamic function to get translated weather effects
function getWeatherEffects() {
    // Helper to get translated strings with fallback to Portuguese
    const tr = (key, fallback) => {
        if (typeof t === 'function') {
            const translated = t(key);
            if (translated && translated !== key) return translated;
        }
        return fallback;
    };

    const pathfind = tr('weather.effect.pathfind', 'em rolagens de DESBRAVAR');
    const camp = tr('weather.effect.camp', 'em rolagens de MONTAR ACAMPAMENTO');
    const coldTable = tr('weather.effect.coldTable', 'para rolar na tabela de FRIO');
    const hotTable = tr('weather.effect.hotTable', 'para rolar na tabela de CALOR');
    const walkRes = tr('weather.walkResilience', 'CAMINHAR requer uma rolagem de Resiliência');

    return {
        'Dia Quente de Sol': `✥ +1 ${pathfind}`,
        'Dia de Frio Cortante': `✥ -1 ${pathfind}`,
        'Céu Limpo': `✥ +1 ${pathfind}`,
        'Garoa': `✥ +1 ${coldTable}<br>✥ -1 ${hotTable}<br>✥ -1 ${pathfind}`,
        'Chuva Leve': `✥ +1 ${coldTable}<br>✥ -1 ${hotTable}<br>✥ -1 ${pathfind}`,
        'Chuva Forte': `✥ +2 ${coldTable}<br>✥ -2 ${hotTable}<br>✥ -2 ${pathfind}<br>✥ ${walkRes}`,
        'Temporal': `✥ +2 ${coldTable}<br>✥ -2 ${hotTable}<br>✥ -2 ${pathfind}<br>✥ ${walkRes}`,
        'Rajada de Neve': `✥ +1 ${coldTable}<br>✥ -1 ${pathfind}<br>`,
        'Neve': `✥ +2 ${coldTable}<br>✥ -2 ${pathfind}<br>✥ ${walkRes}`,
        'Nevasca': `✥ +2 ${coldTable}<br>✥ -2 ${pathfind}<br>✥ ${walkRes}`,
        'Sem Vento': `✥ +1 ${camp}<br>✥ +1 ${hotTable}`,
        'Ventando': `✥ +1 ${coldTable}<br>✥ -1 ${hotTable}<br>✥ -1 ${camp}`,
        'Ventania Forte': `✥ +2 ${coldTable}<br>✥ -2 ${hotTable}<br>✥ -2 ${camp}<br>✥ ${walkRes}.`
    };
}

// Keep weatherEffects as a variable for backwards compatibility, will be updated dynamically
let weatherEffects = getWeatherEffects();

function getImageTitle(imagePath) {
    if (!imagePath) return '';
    const imageName = imagePath.split('/').pop();

    // Weather name translations mapping
    const weatherNames = {
        'ceuLimpo.webp': { key: 'weather.clearSky', fallback: 'Céu Limpo' },
        'chuvaForte.webp': { key: 'weather.heavyRain', fallback: 'Chuva Forte' },
        'chuvaLeve.webp': { key: 'weather.lightRain', fallback: 'Chuva Leve' },
        'diaQuenteDeSol.webp': { key: 'weather.hotSunnyDay', fallback: 'Dia Quente de Sol' },
        'diaDeFrioCortante.webp': { key: 'weather.coldBitingDay', fallback: 'Dia de Frio Cortante' },
        'encoberto.webp': { key: 'weather.overcast', fallback: 'Encoberto' },
        'garoa.webp': { key: 'weather.drizzle', fallback: 'Garoa' },
        'nebuloso.webp': { key: 'weather.foggy', fallback: 'Nebuloso' },
        'nevasca.webp': { key: 'weather.blizzard', fallback: 'Nevasca' },
        'neve.webp': { key: 'weather.snow', fallback: 'Neve' },
        'nuvensClaras.webp': { key: 'weather.lightClouds', fallback: 'Nuvens Claras' },
        'nuvensPesadas.webp': { key: 'weather.heavyClouds', fallback: 'Nuvens Pesadas' },
        'rajadaDeNeve.webp': { key: 'weather.snowFlurry', fallback: 'Rajada de Neve' },
        'temporal.webp': { key: 'weather.storm', fallback: 'Temporal' },
        'vento0.webp': { key: 'weather.noWind', fallback: 'Sem Vento' },
        'vento1.webp': { key: 'weather.breeze', fallback: 'Brisa' },
        'vento2.webp': { key: 'weather.windy', fallback: 'Ventando' },
        'vento3.webp': { key: 'weather.strongWind', fallback: 'Ventania Forte' }
    };

    const weatherItem = weatherNames[imageName];
    if (weatherItem) {
        if (typeof t === 'function') {
            const translated = t(weatherItem.key);
            if (translated && translated !== weatherItem.key) {
                return translated;
            }
        }
        return weatherItem.fallback;
    }
    return '';
}

// Returns the original Portuguese name for use as key in weatherModifiers/weatherEffects lookups
function getOriginalImageTitle(imagePath) {
    if (!imagePath) return '';
    const imageName = imagePath.split('/').pop();

    const originalNames = {
        'ceuLimpo.webp': 'Céu Limpo',
        'chuvaForte.webp': 'Chuva Forte',
        'chuvaLeve.webp': 'Chuva Leve',
        'diaQuenteDeSol.webp': 'Dia Quente de Sol',
        'diaDeFrioCortante.webp': 'Dia de Frio Cortante',
        'encoberto.webp': 'Encoberto',
        'garoa.webp': 'Garoa',
        'nebuloso.webp': 'Nebuloso',
        'nevasca.webp': 'Nevasca',
        'neve.webp': 'Neve',
        'nuvensClaras.webp': 'Nuvens Claras',
        'nuvensPesadas.webp': 'Nuvens Pesadas',
        'rajadaDeNeve.webp': 'Rajada de Neve',
        'temporal.webp': 'Temporal',
        'vento0.webp': 'Sem Vento',
        'vento1.webp': 'Brisa',
        'vento2.webp': 'Ventando',
        'vento3.webp': 'Ventania Forte'
    };

    return originalNames[imageName] || '';
}

function parseEffect(effectString) {
    const effectRegex = /✥\s*([+-]\d+)?\s*(.*)/;
    const match = effectString.match(effectRegex);
    if (match) {
        const value = match[1] ? parseInt(match[1]) : null;
        let description = match[2].trim();
        if (description.endsWith('.')) {
            description = description.slice(0, -1);
        }
        return { value, description };
    }
    return null;
}

function processDataSets(data, excludedPhrases = [], seasonType = 'hot') {
    for (const key in data) {
        const hexagon = data[key];
        // Use translated names for display
        const redTitle = getImageTitle(hexagon.redImage);
        const blueTitle = getImageTitle(hexagon.blueImage);
        // Use original Portuguese names for dictionary lookups
        const redOriginalTitle = getOriginalImageTitle(hexagon.redImage);
        const blueOriginalTitle = getOriginalImageTitle(hexagon.blueImage);

        // Translated connector based on language
        const connector = (typeof t === 'function') ? t('weather.and') : 'e';
        let title = '';
        if (redTitle && blueTitle) {
            title = `${redTitle} ${connector} ${blueTitle}`;
        } else if (redTitle) {
            title = redTitle;
        } else if (blueTitle) {
            title = blueTitle;
        }

        // --- CALCULAR CAMPO MODIFIERS ESTRUTURADO (use original Portuguese names for lookups) ---
        const redMods = weatherModifiers[redOriginalTitle] || { desbravar: 0, acampar: 0, coletar: 0, cacar: 0, temperaturaMod: { hot: 0, cold: 0 }, outros: [] };
        const blueMods = weatherModifiers[blueOriginalTitle] || { desbravar: 0, acampar: 0, coletar: 0, cacar: 0, temperaturaMod: { hot: 0, cold: 0 }, outros: [] };

        // Combinar outros - verificar condição especial de Resiliência combinada
        const redImageName = hexagon.redImage ? hexagon.redImage.split('/').pop() : null;
        const blueImageName = hexagon.blueImage ? hexagon.blueImage.split('/').pop() : null;
        const conditionRed = ['chuvaForte.webp', 'temporal.webp', 'neve.webp', 'nevasca.webp'].includes(redImageName);
        const conditionBlue = blueImageName === 'vento3.webp';

        // Translation helper for walk resilience messages
        const walkResilienceBase = typeof t === 'function' && t('weather.walkResilience') !== 'weather.walkResilience'
            ? t('weather.walkResilience')
            : 'CAMINHAR requer uma rolagem de Resiliência';
        const walkResiliencePenalty = typeof t === 'function' && t('weather.walkResiliencePenalty') !== 'weather.walkResiliencePenalty'
            ? t('weather.walkResiliencePenalty')
            : 'CAMINHAR requer uma rolagem de Resiliência com um redutor de -2.';

        let combinedOutros = [];
        if (conditionRed && conditionBlue) {
            // Combinação especial: Resiliência com redutor de -2
            combinedOutros.push(walkResiliencePenalty);
        } else {
            // Adicionar outros sem duplicação - translate if needed
            const translateOutro = (o) => {
                // Map Portuguese strings to translation keys
                if (o === 'CAMINHAR requer uma rolagem de Resiliência.') {
                    return walkResilienceBase + '.';
                }
                return o;
            };
            redMods.outros.forEach(o => {
                const translated = translateOutro(o);
                if (!combinedOutros.includes(translated)) combinedOutros.push(translated);
            });
            blueMods.outros.forEach(o => {
                const translated = translateOutro(o);
                if (!combinedOutros.includes(translated)) combinedOutros.push(translated);
            });
        }

        // Calcular modificador de temperatura baseado na estação
        let tempMod = 0;
        if (seasonType === 'hot') {
            tempMod = (redMods.temperaturaMod?.hot || 0) + (blueMods.temperaturaMod?.hot || 0);
        } else {
            tempMod = (redMods.temperaturaMod?.cold || 0) + (blueMods.temperaturaMod?.cold || 0);
        }

        hexagon.modifiers = {
            desbravar: redMods.desbravar + blueMods.desbravar,
            acampar: redMods.acampar + blueMods.acampar,
            coletar: redMods.coletar + blueMods.coletar,
            cacar: redMods.cacar + blueMods.cacar,
            temperaturaMod: tempMod,
            outros: combinedOutros,
            // Manter referências para ícones
            sources: {
                red: { title: redTitle, image: hexagon.redImage },
                blue: { title: blueTitle, image: hexagon.blueImage }
            }
        };

        // --- MANTER LÓGICA DE GERAÇÃO DE TEXTO HTML PARA RETROCOMPATIBILIDADE ---
        const redEffectStrings = (redOriginalTitle && weatherEffects[redOriginalTitle]) ? weatherEffects[redOriginalTitle].split('<br>') : [];
        const blueEffectStrings = (blueOriginalTitle && weatherEffects[blueOriginalTitle]) ? weatherEffects[blueOriginalTitle].split('<br>') : [];

        // Track effects and their sources
        const effectsMap = new Map(); // Key: description, Value: { value: num, sources: [] }

        const addEffects = (strings, sourceImage) => {
            for (const effectString of strings) {
                const parsed = parseEffect(effectString);
                if (parsed) {
                    const { value, description } = parsed;

                    // Check exclusions
                    if (excludedPhrases.some(phrase => description.includes(phrase))) {
                        continue;
                    }

                    if (effectsMap.has(description)) {
                        const existing = effectsMap.get(description);
                        // Accumulate value if both are numeric
                        if (existing.value !== null && value !== null) {
                            existing.value += value;
                        }
                        if (sourceImage && !existing.sources.includes(sourceImage)) {
                            existing.sources.push(sourceImage);
                        }
                    } else {
                        // First time seeing this description
                        effectsMap.set(description, { value, sources: sourceImage ? [sourceImage] : [] });
                    }
                }
            }
        };

        addEffects(redEffectStrings, hexagon.redImage);
        addEffects(blueEffectStrings, hexagon.blueImage);

        if (conditionRed && conditionBlue) {
            if (effectsMap.has(walkResilienceBase)) {
                const oldEntry = effectsMap.get(walkResilienceBase);
                effectsMap.delete(walkResilienceBase);

                // Add new entry with combined sources
                effectsMap.set(walkResiliencePenalty.replace(/\.$/, ''), {
                    value: null,
                    sources: oldEntry.sources
                });
            }
        }

        let effectsString = '';
        for (const [description, { value, sources }] of effectsMap.entries()) {
            if (effectsString) effectsString += '<br>';

            // Build tags
            let tagsHtml = '';
            sources.forEach(src => {
                tagsHtml += `<img src="${src}" class="source-tag" onclick="showGeneralPopup('${src}')">`;
            });
            // Fallback for no source? Should not happen given logic, but maybe for manual adds.
            if (!tagsHtml) tagsHtml = `<span style="font-size:1.2em; vertical-align:middle; margin-right:5px;">✥</span>`;

            if (value !== null && value !== 0) {
                const sign = value > 0 ? '+' : '';
                effectsString += `${tagsHtml} ${sign}${value} ${description}`;
            } else if (value === null) {
                effectsString += `${tagsHtml} ${description}`;
            }
        }

        if (title) {
            hexagon.text = `<b>${title}</b>`;
            if (effectsString) {
                hexagon.text += `<br>${effectsString}`;
            }
        }
    }
}

// Process all sets
processDataSets(hexagonDataWarm, ['para rolar na tabela de FRIO'], 'hot');
processDataSets(hexagonDataIntermediate, ['para rolar na tabela de CALOR'], 'cold');
processDataSets(hexagonDataWinter, ['para rolar na tabela de CALOR'], 'cold');

// Initialize with a default, but script.js will update it
let hexagonData = hexagonDataWarm;

function updateActiveHexagonData(monthName) {
    if (['Minguaprimavera', 'Cresceverão', 'Minguaverão', 'Cresceoutono'].includes(monthName)) {
        hexagonData = hexagonDataWarm;
    } else if (['Cresceprimavera', 'Minguaoutono'].includes(monthName)) {
        hexagonData = hexagonDataIntermediate;
    } else if (['Cresceinverno', 'Minguainverno'].includes(monthName)) {
        hexagonData = hexagonDataWinter;
    }
}

// Listen for language changes to refresh weather effects
window.addEventListener('languageChanged', function () {
    // Regenerate weatherEffects with new translations
    weatherEffects = getWeatherEffects();

    // Reprocess hexagon data sets with new translations
    processDataSets(hexagonDataWarm, ['para rolar na tabela de FRIO'], 'hot');
    processDataSets(hexagonDataIntermediate, ['para rolar na tabela de CALOR'], 'cold');
    processDataSets(hexagonDataWinter, ['para rolar na tabela de CALOR'], 'cold');
});
